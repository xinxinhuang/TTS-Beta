@page
@model TeeTime.Pages.TeeSheet.ViewModel
@{
    ViewData["Title"] = "View Tee Sheet";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Tee Sheet - Week of @Model.StartDate.ToString("MMMM d, yyyy")</h2>
        <a asp-page="./Manage" class="btn btn-primary">Back to Management</a>
    </div>
    
    <!-- Calendar View -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Tee Sheet Calendar</h5>
        </div>
        <div class="card-body">
            <div id="teesheet-calendar"></div>
        </div>
    </div>
    
    <!-- Reservation Details Modal -->
    <div class="modal fade" id="reservation-details-modal" tabindex="-1" aria-labelledby="reservation-details-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservation-details-modal-label">Reservation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="reservation-title"></h4>
                    <p><strong>Time:</strong> <span id="reservation-time"></span></p>
                    <p><strong>Players:</strong> <span id="reservation-players"></span></p>
                    <p><strong>Carts:</strong> <span id="reservation-carts"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Details Modal -->
    <div class="modal fade" id="event-details-modal" tabindex="-1" aria-labelledby="event-details-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="event-details-modal-label">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="event-details-title"></h4>
                    <p><strong>Time:</strong> <span id="event-details-time"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <a asp-page="./Manage" class="btn btn-primary">Back to Management</a>
    </div>
</div>

@section Scripts {
    <script src="~/lib/fullcalendar/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the calendar element
            const calendarEl = document.getElementById('teesheet-calendar');
            
            if (!calendarEl) return;
        
            // Initialize the calendar
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                initialDate: '@Model.StartDate.ToString("yyyy-MM-dd")',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '07:00:00',
                slotMaxTime: '19:00:00',
                slotDuration: '00:08:00',
                allDaySlot: false,
                height: 'auto',
                expandRows: true,
                navLinks: true,
                selectable: false,
                selectMirror: true,
                dayMaxEvents: true,
                weekNumbers: true,
                nowIndicator: true,
                businessHours: {
                    daysOfWeek: [0, 1, 2, 3, 4, 5, 6], // Sunday - Saturday
                    startTime: '07:00',
                    endTime: '19:00',
                },
                // Event handling
                eventClick: function(info) {
                    // When an event is clicked
                    if (info.event.extendedProps.isReservation) {
                        // Show reservation details
                        if (document.getElementById('reservation-details-modal')) {
                            document.getElementById('reservation-title').textContent = info.event.title;
                            document.getElementById('reservation-time').textContent = 
                                info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            document.getElementById('reservation-players').textContent = 
                                info.event.extendedProps.players || 'N/A';
                            document.getElementById('reservation-carts').textContent = 
                                info.event.extendedProps.carts || 'N/A';
                            
                            // Show the modal
                            const reservationModal = new bootstrap.Modal(document.getElementById('reservation-details-modal'));
                            reservationModal.show();
                        }
                    } else if (info.event.extendedProps.isEvent) {
                        // Show event details
                        if (document.getElementById('event-details-modal')) {
                            document.getElementById('event-details-title').textContent = info.event.title;
                            document.getElementById('event-details-time').textContent = 
                                info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' - ' +
                                info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Show the modal
                            const eventDetailsModal = new bootstrap.Modal(document.getElementById('event-details-modal'));
                            eventDetailsModal.show();
                        }
                    }
                },
                // Load events from the server
                events: function(info, successCallback, failureCallback) {
                    // Get the start and end dates from the calendar
                    const start = info.startStr;
                    const end = info.endStr;
                    
                    // Make an AJAX request to get the events
                    fetch(`/api/TeeSheet/GetEvents?start=${start}&end=${end}`)
                        .then(response => response.json())
                        .then(data => {
                            successCallback(data);
                        })
                        .catch(error => {
                            console.error('Error fetching events:', error);
                            failureCallback(error);
                        });
                }
            });
        
            calendar.render();
        });
    </script>
}
